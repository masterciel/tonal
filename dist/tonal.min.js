"use strict";var noteParse=require("note-parser").parse;var ivlNttn=require("interval-notation");var isArr=Array.isArray;var isNum=function isNum(n){return typeof n==="number"};var isStr=function isStr(o){return typeof o==="string"};var isDef=function isDef(o){return typeof o!=="undefined"};var isValue=function isValue(v){return v!==null&&typeof v!=="undefined"};var id=function id(x){return x};var pcArr=function pcArr(f){return["tnl",f]};var noteArr=function noteArr(f,o){return["tnl",f,o]};var calcDir=function calcDir(f,o){return encDir(7*f+12*o)};var ivlArr=function ivlArr(f,o,d){return["tnl",f,o,d||calcDir(f,o)]};var isPitch=function isPitch(p){return p&&p[0]==="tnl"};var isPitchClass=function isPitchClass(p){return isPitch(p)&&p.length===2};var hasOct=function hasOct(p){return isPitch(p)&&isNum(p[2])};var isNotePitch=function isNotePitch(p){return hasOct(p)&&p.length===3};var isInterval=function isInterval(i){return hasOct(i)&&isNum(i[3])};var isPitchNotIvl=function isPitchNotIvl(i){return isPitch(i)&&!isDef(i[3])};var FIFTHS=[0,2,4,-1,1,3,5];var encPC=function encPC(step,alt){return FIFTHS[step]+7*alt};var fOcts=function fOcts(f){return Math.floor(f*7/12)};var FIFTH_OCTS=FIFTHS.map(fOcts);var encOct=function encOct(step,alt,oct){return oct-FIFTH_OCTS[step]-4*alt};var encDir=function encDir(n){return n<0?-1:1};function encode(step,alt,oct,dir){if(step<0||step>6)return null;var pc=encPC(step,alt||0);if(!isNum(oct))return pcArr(pc);var o=encOct(step,alt,oct);if(!isNum(dir))return noteArr(pc,o);var d=encDir(dir);return ivlArr(d*pc,d*o,d)}function unaltered(f){var i=(f+1)%7;return i<0?7+i:i}var decodeStep=function decodeStep(f){return STEPS[unaltered(f)]};var decodeAlt=function decodeAlt(f){return Math.floor((f+1)/7)};var STEPS=[3,0,4,1,5,2,6];function decode(p){var s=decodeStep(p[1]);var a=decodeAlt(p[1]);var o=isNum(p[2])?p[2]+4*a+FIFTH_OCTS[s]:null;return{step:s,alt:a,oct:o,dir:p[3]||null}}var cached=function cached(parser){var cache={};return function(str){if(typeof str!=="string")return null;return cache[str]||(cache[str]=parser(str))}};var parseNote=cached(function(str){var n=noteParse(str);return n?encode(n.step,n.alt,n.oct):null});var isNoteStr=function isNoteStr(s){return parseNote(s)!==null};var parseIvl=cached(function(str){var i=ivlNttn.parse(str);return i?encode(i.simple-1,i.alt,i.oct,i.dir):null});var isIntervalStr=function isIntervalStr(s){return parseIvl(s)!==null};var parsePitch=function parsePitch(str){return parseNote(str)||parseIvl(str)};var toLetter=function toLetter(s){return"CDEFGAB"[s%7]};var fillStr=function fillStr(s,num){return Array(Math.abs(num)+1).join(s)};var toAcc=function toAcc(n){return fillStr(n<0?"b":"#",n)};var strNum=function strNum(n){return n!==null?n:""};function strNote(n){var p=isPitch(n)&&!n[3]?decode(n):null;return p?toLetter(p.step)+toAcc(p.alt)+strNum(p.oct):null}var isAsc=function isAsc(p){return p.dir===1};var isPerf=function isPerf(p){return ivlNttn.type(p.step+1)==="P"};var calcNum=function calcNum(p){return isAsc(p)?p.step+1+7*p.oct:8-p.step-7*(p.oct+1)};var calcAlt=function calcAlt(p){return isAsc(p)?p.alt:isPerf(p)?-p.alt:-(p.alt+1)};function strIvl(pitch){var p=isInterval(pitch)?decode(pitch):null;if(!p)return null;var num=calcNum(p);return p.dir*num+ivlNttn.altToQ(num,calcAlt(p))}var strPitch=function strPitch(p){return p[3]?strIvl(p):strNote(p)};var notation=function notation(parse,str){return function(v){return!isPitch(v)?parse(v):str(v)}};var asNote=notation(parseNote,id);var asIvl=notation(parseIvl,id);var asPitch=notation(parsePitch,id);var toNoteStr=notation(id,strNote);var toIvlStr=notation(id,strIvl);var toPitchStr=notation(id,strPitch);var pitchOp=function pitchOp(parse,to){return function(fn){return function(v){var isP=isPitch(v);if(isP)return fn(v);var p=parse(v);return p?to(fn(p)):null}}};var noteFn=pitchOp(parseNote,toNoteStr);var ivlFn=pitchOp(parseIvl,toIvlStr);var pitchFn=pitchOp(parsePitch,toPitchStr);var note=noteFn(id);var pc=noteFn(function(p){return["tnl",p[1]]});var chroma=pitchFn(function(n){return 7*n[1]-12*fOcts(n[1])});var letter=noteFn(function(n){return toLetter(decode(n).step)});var accidentals=noteFn(function(n){return toAcc(decode(n).alt)});var octave=pitchFn(function(p){return decode(p).oct});var simplify=ivlFn(function(i){var d=i[3];var s=decodeStep(d*i[1]);var a=decodeAlt(d*i[1]);return ivlArr(i[1],-d*(FIFTH_OCTS[s]+4*a),d)});var simplifyAsc=ivlFn(function(i){var s=simplify(i);return s[3]===1?s:ivlArr(s[1],s[2]+1,1)});var simpleNum=ivlFn(function(i){var p=decode(i);return p.step+1});var number=ivlFn(function(i){return calcNum(decode(i))});var quality=ivlFn(function(i){var p=decode(i);return ivlNttn.altToQ(p.step+1,p.alt)});var height=function height(p){return p[1]*7+12*p[2]};var semitones=ivlFn(height);var isMidi=function isMidi(m){return isValue(m)&&!isArr(m)&&m>=0&&m<128};var midi=function midi(val){var p=asNote(val);return hasOct(p)?height(p)+12:isMidi(val)?+val:null};var PCS="C Db D Eb E F Gb G Ab A Bb B".split(" ");var fromMidi=function fromMidi(m){var pc=PCS[m%12];var o=Math.floor(m/12)-1;return pc+o};var wellTempered=function wellTempered(ref){return function(pitch){var m=midi(pitch);return m?Math.pow(2,(m-69)/12)*ref:null}};var freq=wellTempered(440);function trBy(i,p){if(p===null)return null;var f=i[1]+p[1];if(p.length===2)return["tnl",f];var o=i[2]+p[2];if(p.length===3)return["tnl",f,o];return["tnl",f,o,calcDir(f,o)]}function transpose(a,b){if(arguments.length===1)return function(b){return transpose(a,b)};var pa=asPitch(a);var pb=asPitch(b);var r=isInterval(pa)?trBy(pa,pb):isInterval(pb)?trBy(pb,pa):null;return toPitchStr(r)}var tr=transpose;function substr(a,b){if(a.length!==b.length)return null;return isPitchClass(a)?ivlArr(b[1]-a[1],-fOcts(b[1]-a[1]),1):ivlArr(b[1]-a[1],b[2]-a[2])}function distance(a,b){if(arguments.length===1)return function(b){return distance(a,b)};var pa=asPitch(a);var pb=asPitch(b);var i=substr(pa,pb);return a===pa&&b===pb?i:toIvlStr(i)}var dist=distance;var interval=distance;var SEP=/\s*\|\s*|\s*,\s*|\s+/;function asArr(src){return isArr(src)?src:typeof src==="string"?src.trim().split(SEP):src===null||typeof src==="undefined"?[]:[src]}function map(fn,list){return arguments.length>1?map(fn)(list):function(l){return asArr(l).map(fn)}}function filter(fn,list){return arguments.length>1?filter(fn)(list):function(l){return asArr(l).filter(fn)}}var listToStr=function listToStr(v){return isPitch(v)?toPitchStr(v):isArr(v)?v.map(toPitchStr):v};var listFn=function listFn(fn){return function(src){var param=asArr(src).map(asPitch);var result=fn(param);return listToStr(result)}};var harmonizer=function harmonizer(list){return function(pitch){return listFn(function(list){return list.map(transpose(pitch||"P1")).filter(id)})(list)}};var harmonize=function harmonize(list,pitch){return arguments.length>1?harmonizer(list)(pitch):harmonizer(list)};var ascR=function ascR(b,n){for(var a=[];n--;a[n]=n+b){}return a};var descR=function descR(b,n){for(var a=[];n--;a[n]=b-n){}return a};function range(a,b){var ma=isNum(a)?a:midi(a);var mb=isNum(b)?b:midi(b);return ma===null||mb===null?[]:ma<mb?ascR(ma,mb-ma+1):descR(ma,ma-mb+1)}function noteRange(fn,a,b){if(arguments.length===1)return function(a,b){return noteRange(fn,a,b)};return range(a,b).map(fn).filter(function(x){return x!==null})}var chromatic=noteRange(fromMidi);function fifthsFrom(t,n){if(arguments.length>1)return fifthsFrom(t)(n);return function(n){return tr(t,ivlArr(n,0))}}var objHeight=function objHeight(p){if(!p)return-Infinity;var f=p[1]*7;var o=isNum(p[2])?p[2]:-Math.floor(f/12)-10;return f+o*12};var ascComp=function ascComp(a,b){return objHeight(a)-objHeight(b)};var descComp=function descComp(a,b){return-ascComp(a,b)};function sort(comp,list){if(arguments.length>1)return sort(comp)(list);var fn=comp===true||comp===null?ascComp:comp===false?descComp:comp;return listFn(function(arr){return arr.sort(fn)})}exports.isArr=isArr;exports.isNum=isNum;exports.isStr=isStr;exports.isDef=isDef;exports.isValue=isValue;exports.id=id;exports.pcArr=pcArr;exports.noteArr=noteArr;exports.ivlArr=ivlArr;exports.isPitch=isPitch;exports.isPitchClass=isPitchClass;exports.hasOct=hasOct;exports.isNotePitch=isNotePitch;exports.isInterval=isInterval;exports.isPitchNotIvl=isPitchNotIvl;exports.encode=encode;exports.decode=decode;exports.parseNote=parseNote;exports.isNoteStr=isNoteStr;exports.parseIvl=parseIvl;exports.isIntervalStr=isIntervalStr;exports.toLetter=toLetter;exports.toAcc=toAcc;exports.strNote=strNote;exports.strIvl=strIvl;exports.note=note;exports.pc=pc;exports.chroma=chroma;exports.letter=letter;exports.accidentals=accidentals;exports.octave=octave;exports.simplify=simplify;exports.simplifyAsc=simplifyAsc;exports.simpleNum=simpleNum;exports.number=number;exports.quality=quality;exports.semitones=semitones;exports.isMidi=isMidi;exports.midi=midi;exports.fromMidi=fromMidi;exports.wellTempered=wellTempered;exports.freq=freq;exports.transpose=transpose;exports.tr=tr;exports.distance=distance;exports.dist=dist;exports.interval=interval;exports.asArr=asArr;exports.map=map;exports.filter=filter;exports.listFn=listFn;exports.harmonizer=harmonizer;exports.harmonize=harmonize;exports.range=range;exports.noteRange=noteRange;exports.chromatic=chromatic;exports.fifthsFrom=fifthsFrom;exports.sort=sort;
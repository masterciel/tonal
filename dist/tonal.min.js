"use strict";var isArr=Array.isArray;var pitch=function pitch(s,a,o){return o||o===0?[s,a,o]:[s,a]};var PITCH_REGEX=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d{0,1})$/;var pitchRegex=function pitchRegex(){return PITCH_REGEX};var STEPS="CDEFGAB";var step=function step(l){return STEPS.indexOf(l.toUpperCase())};function accToAlt(acc){var alt=acc.replace(/x/g,"##").length;return acc[0]==="b"?-alt:alt}function parseSci(str){var m=PITCH_REGEX.exec(str);if(!m)return null;var l=step(m[1]);var a=accToAlt(m[2]);var o=m[3]?+m[3]:null;return pitch(l,a,o)}function cache(parser){var cache={};return function(str){if(typeof str!=="string")return null;return cache[str]||(cache[str]=parser(str))}}var pitchParse=cache(parseSci);var pitchArr=function pitchArr(p){return isArr(p)?p:pitchParse(p)};var prop=function prop(fn){return function(p){return fn(pitchArr(p))}};var letter=prop(function(p){return STEPS[p[0]]});var alt=prop(function(p){return p[1]});var altToAcc=function altToAcc(alt){return Array(Math.abs(alt)+1).join(alt<0?"b":"#")};var accidentals=function accidentals(p){return altToAcc(alt(p))};var hasOct=function hasOct(p){return isArr(p)&&typeof p[2]!=="undefined"};var octOr=function octOr(d){return function(p){return hasOct(p)?p[2]:d}};var octStr=octOr("");var octNum=octOr(0);var oct=prop(octOr(null));var pitchStr=function pitchStr(p){return letter(p)+accidentals(p)+octStr(p)};var isMidi=function isMidi(m){return!isArr(m)&&m>0&&m<129};var HEIGHTS=[0,2,4,5,7,9,11];var chroma=prop(function(p){return HEIGHTS[p[0]]+p[1]});var height=prop(function(p){return chroma(p)+12*octNum(p)});var midi=function midi(p){var a=pitchArr(p);return hasOct(a)?height(a)+12:isMidi(p)?+p:null};var CHROMATIC=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];function fromMidi(num){var midi=+num;return isNaN(midi)||midi<0||midi>127?null:CHROMATIC[midi%12]+(Math.floor(midi/12)-1)}var wellTempered=function wellTempered(ref){return function(pitch){var m=midi(pitch);return m?Math.pow(2,(m-69)/12)*ref:null}};var toFreq=wellTempered(440);var ivl=function ivl(s,a,o,d){return[s,a,o,d]};var ivlStep=function ivlStep(n){return(n-1)%7};var TYPES="PMMPPMM";function qToAlt(type,q){if(type==="P"){if(q==="P")return 0;else if(q[0]==="A")return q.length;else if(q[0]==="d")return-q.length}else if(type==="M"){if(q==="M")return 0;else if(q==="m")return-1;else if(q[0]==="A")return q.length;else if(q[0]==="d")return-(q.length+1)}return null}var IVL_TNL="([-+]?)(\\d+)(d{1,4}|m|M|P|A{1,4})";var IVL_STR="(AA|A|P|M|m|d|dd)([-+]?)(\\d+)";var COMPOSE="(?:("+IVL_TNL+")|("+IVL_STR+"))";var IVL_REGEX=new RegExp("^"+COMPOSE+"$");function ivlRegex(){return IVL_REGEX}var ivlParse=cache(function(str){var m=IVL_REGEX.exec(str);if(!m)return null;var num=+(m[3]||m[8]);var step=ivlStep(num);var alt=qToAlt(TYPES[step],m[4]||m[6]);var oct=Math.floor((num-1)/7);var dir=(m[2]||m[7])==="-"?-1:1;return ivl(step,alt,oct,dir)});var number=function number(i){return i[0]+1+7*octNum(i[2])};var ivlType=function ivlType(i){return TYPES[i[0]]};var ALTER={P:["dddd","ddd","dd","d","P","A","AA","AAA","AAAA"],M:["ddd","dd","d","m","M","A","AA","AAA","AAAA"]};var quality=function quality(i){return ALTER[ivlType(i)][4+alt(i)]};var direction=function direction(i){return i[4]};var dirStr=function dirStr(p){return direction(p)===-1?"-":""};var ivlStr=function ivlStr(p){return dirStr(p)+number(p)+quality(p)};var BASES=[[0,0],[2,-1],[4,-2],[-1,1],[1,0],[3,-1],[5,-2]];function toCoord(step,alt,oct,dir){var base=BASES[step];var f=base[0]+7*alt;if(!oct&&oct!==0)return[f];var o=oct+base[1]-4*alt;if(!dir)return[f,o];else return[f,o,dir]}var coord=function coord(p){return p?toCoord.apply(null,p):null};var PCS=[[3,1],[0,0],[4,0],[1,-1],[5,-1],[2,-2],[6,-2],[3,-3]];function toArray(f,o,d){var index=(f+1)%7;var pc=PCS[index<0?7+index:index];var step=pc[0];var alt=Math.floor((f+1)/7);if(!o&&o!==0)return[step,alt];var oct=o-pc[1]+alt*4;return!d?[step,alt,oct]:[step,alt,oct,d]}var coordArr=function coordArr(c){return c?toArray.apply(null,c):null};var add=function add(a,b){switch(Math.min(a.length,b.length)){case 1:return[a[0]+b[0]];case 2:return[a[0]+b[0],a[1]+b[1]];case 3:return[a[0]+b[0],a[1]+b[1],a[2]+b[2]];case 4:return[a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3]];default:[]}};function trBy(i,p){if(!isArr(i)||!isArr(p))return null;return pitchStr(coordArr(add(coord(i),coord(p))))}function transpose(a,b){if(arguments.length===1)return function(c){return transpose(a,c)};return trBy(ivlParse(a)||a,pitchParse(b)||b)||trBy(ivlParse(b)||b,pitchParse(a)||a)}var tr=transpose;var SEP=/\s*\|\s*|\s*,\s*|\s+/;function split(source){return isArr(source)?source:typeof source==="string"?source.trim().split(SEP):source===null||typeof source==="undefined"?[]:[source]}function map(fn,list){if(arguments.length===1)return function(l){return map(fn,l)};return split(list).map(fn)}function harmonize(list,tonic){return split(list).map(tr(tonic))}exports.pitch=pitch;exports.pitchRegex=pitchRegex;exports.step=step;exports.accToAlt=accToAlt;exports.pitchParse=pitchParse;exports.letter=letter;exports.alt=alt;exports.altToAcc=altToAcc;exports.accidentals=accidentals;exports.oct=oct;exports.pitchStr=pitchStr;exports.isMidi=isMidi;exports.chroma=chroma;exports.height=height;exports.midi=midi;exports.fromMidi=fromMidi;exports.wellTempered=wellTempered;exports.toFreq=toFreq;exports.ivlStep=ivlStep;exports.qToAlt=qToAlt;exports.ivlRegex=ivlRegex;exports.ivlParse=ivlParse;exports.number=number;exports.ivlType=ivlType;exports.quality=quality;exports.direction=direction;exports.ivlStr=ivlStr;exports.coord=coord;exports.coordArr=coordArr;exports.transpose=transpose;exports.tr=tr;exports.split=split;exports.map=map;exports.harmonize=harmonize;
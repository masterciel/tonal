<!DOCTYPE html>

<html>
<head>
  <title>Tonal</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          
          <h1 id="tonal">Tonal</h1>
<h4 id="prelude">Prelude</h4>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> note = <span class="hljs-built_in">require</span>(<span class="hljs-string">'note-parser'</span>)
<span class="hljs-keyword">const</span> ivl = <span class="hljs-built_in">require</span>(<span class="hljs-string">'interval-notation'</span>)
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> isArr = <span class="hljs-built_in">Array</span>.isArray
<span class="hljs-keyword">const</span> isNum = (n) =&gt; <span class="hljs-keyword">typeof</span> n === <span class="hljs-string">'number'</span>
</code></pre>
<h2 id="1-pitches">1. Pitches</h2>
<h4 id="pitch-encoding">Pitch encoding</h4>
<pre><code class="lang-js"><span class="hljs-comment">// map from letter step to number of fifths and octaves</span>
<span class="hljs-keyword">const</span> FIFTHS = [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>]
<span class="hljs-comment">// encode a pitch class using the step number and alteration</span>
<span class="hljs-keyword">const</span> encPC = (step, alt) =&gt; FIFTHS[step] + <span class="hljs-number">7</span> * alt
</code></pre>
<pre><code class="lang-js"><span class="hljs-comment">// given a number of fifths, return the octaves they span</span>
<span class="hljs-keyword">const</span> fifthsSpan = (f) =&gt; <span class="hljs-built_in">Math</span>.floor(f * <span class="hljs-number">7</span> / <span class="hljs-number">12</span>)
<span class="hljs-comment">// get the number of octaves it span each step</span>
<span class="hljs-keyword">const</span> OCTS = FIFTHS.map(fifthsSpan)
<span class="hljs-keyword">const</span> encOct = (step, alt, oct) =&gt; oct - OCTS[step] - <span class="hljs-number">4</span> * alt
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pitch</span> (<span class="hljs-params">step, alt, oct, dir</span>) </span>{
  <span class="hljs-comment">// is valid step?</span>
  <span class="hljs-keyword">if</span> (step &lt; <span class="hljs-number">0</span> || step &gt; <span class="hljs-number">6</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
  <span class="hljs-keyword">const</span> pc = encPC(step, alt || <span class="hljs-number">0</span>)
  <span class="hljs-comment">// if not octave, return the pitch class</span>
  <span class="hljs-keyword">if</span> (!isNum(oct)) <span class="hljs-keyword">return</span> [ pc ]
  <span class="hljs-keyword">const</span> o = encOct(step, alt, oct)
  <span class="hljs-comment">// return dir ? interval : note pitch</span>
  <span class="hljs-keyword">return</span> dir ? [ pc, o, dir &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">-1</span> : <span class="hljs-number">1</span>] : [ pc, o ]
}
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> isPitch = (p) =&gt; isArr(p) &amp;&amp; isNum(p[<span class="hljs-number">0</span>])
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> isPitchClass = (p) =&gt; isArr(p) &amp;&amp; p.length === <span class="hljs-number">1</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> hasOct = (p) =&gt; isPitch(p) &amp;&amp; isNum(p.oct)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> isPitchNote = (p) =&gt; hasOct(p) &amp;&amp; p.length === <span class="hljs-number">2</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> isInterval = (i) =&gt; hasOct(i) &amp;&amp; isNum(i.dir)
</code></pre>
<h3 id="pitch-decoding">Pitch decoding</h3>
<pre><code class="lang-js"><span class="hljs-comment">// remove accidentals to a pitch class</span>
<span class="hljs-comment">// it gets an array and return a number of fifths</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unaltered</span> (<span class="hljs-params">p</span>) </span>{
  <span class="hljs-keyword">const</span> i = (p[<span class="hljs-number">0</span>] + <span class="hljs-number">1</span>) % <span class="hljs-number">7</span>
  <span class="hljs-keyword">return</span> i &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">7</span> + i : i
}
</code></pre>
<pre><code class="lang-js"><span class="hljs-comment">// 'FCGDAEB' steps numbers</span>
<span class="hljs-keyword">const</span> STEPS = [<span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>]
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">decode</span> (<span class="hljs-params">p</span>) </span>{
  <span class="hljs-keyword">const</span> step = STEPS[unaltered(p)]
  <span class="hljs-keyword">const</span> alt = <span class="hljs-built_in">Math</span>.floor((p[<span class="hljs-number">0</span>] + <span class="hljs-number">1</span>) / <span class="hljs-number">7</span>)
  <span class="hljs-keyword">const</span> oct = isNum(p[<span class="hljs-number">1</span>]) ? p[<span class="hljs-number">1</span>] + <span class="hljs-number">4</span> * alt + OCTS[step] : <span class="hljs-literal">null</span>
  <span class="hljs-keyword">return</span> { step: step, alt: alt, oct: oct, dir: p[<span class="hljs-number">2</span>] }
}
</code></pre>
<h4 id="pitch-parsers">Pitch parsers</h4>
<p>Convert from string to pitches is a quite expensive operation that itâ€™s executed a lot of times. Some caching will help:</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> cache = {}
<span class="hljs-keyword">const</span> cached = (parser) =&gt; (str) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> str !== <span class="hljs-string">'string'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
  <span class="hljs-keyword">return</span> cache[str] || (cache[str] = parser(str))
}
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> parseNote = cached((str) =&gt; {
  <span class="hljs-keyword">const</span> n = note.parse(str)
  <span class="hljs-keyword">return</span> n ? pitch(n.step, n.alt, n.oct) : <span class="hljs-literal">null</span>
})
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> parseIvl = cached((str) =&gt; {
  <span class="hljs-keyword">const</span> i = ivl.parse(str)
  <span class="hljs-keyword">return</span> i ? pitch(i.simple - <span class="hljs-number">1</span>, i.alt, i.oct, i.dir) : <span class="hljs-literal">null</span>
})
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> parsePitch = (str) =&gt; parseNote(str) || parseIvl(str)
</code></pre>
<h3 id="pitch-to-string">Pitch to string</h3>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> stepLetter = (s) =&gt; <span class="hljs-string">'CDEFGAB'</span>[s]
<span class="hljs-keyword">const</span> fillStr = (s, num) =&gt; <span class="hljs-built_in">Array</span>(<span class="hljs-built_in">Math</span>.abs(num) + <span class="hljs-number">1</span>).join(s)
<span class="hljs-keyword">const</span> altAcc = (n) =&gt; fillStr(n &lt; <span class="hljs-number">0</span> ? <span class="hljs-string">'b'</span> : <span class="hljs-string">'#'</span>, n)
<span class="hljs-keyword">const</span> strNum = (n) =&gt; n !== <span class="hljs-literal">null</span> ? n : <span class="hljs-string">''</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">strNote</span> (<span class="hljs-params">pitch</span>) </span>{
  <span class="hljs-keyword">const</span> p = decode(pitch)
  <span class="hljs-keyword">return</span> p ? stepLetter(p.step) + altAcc(p.alt) + strNum(p.oct) : <span class="hljs-literal">null</span>
}
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> calcNum = (props) =&gt; props.step + <span class="hljs-number">1</span> + <span class="hljs-number">7</span> * props.oct
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">strIvl</span> (<span class="hljs-params">pitch</span>) </span>{
  <span class="hljs-keyword">const</span> p = decode(pitch)
  <span class="hljs-keyword">const</span> num = calcNum(props)
  <span class="hljs-keyword">return</span> p ? strDir(p.dir) + num + ivl.altToQ(num, p.alt) : <span class="hljs-literal">null</span>
}
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> strPitch = (p) =&gt; p.dir ? strIvl(p) : strNote(p)
</code></pre>
<h4 id="decorate-pitch-transform-functions">Decorate pitch transform functions</h4>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> notation = (parse, str) =&gt; (v) =&gt; !isPitch(v) ? parse(v) : str(v)
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> id = (x) =&gt; x
<span class="hljs-keyword">const</span> expectNote = notation(parseNote, id)
<span class="hljs-keyword">const</span> expectIvl = notation(parseIvl, id)
<span class="hljs-keyword">const</span> expectPitch = notation(parsePitch, id)
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> toNoteStr = notation(id, strNote)
<span class="hljs-keyword">const</span> toIvlStr = notation(id, strIvl)
<span class="hljs-keyword">const</span> toPitchStr = notation(id, strPitch)
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> buildFnDec = (expect, to) =&gt; (fn) =&gt; (v) =&gt; to(fn(expect(v)))
<span class="hljs-keyword">const</span> noteFn = buildFnDec(expectNote, toNoteStr)
<span class="hljs-keyword">const</span> ivlFn = buildFnDec(expectIvl, toIvlStr)
<span class="hljs-keyword">const</span> pitchFn = buildFnDec(expectPitch, toPitchStr)
</code></pre>
<h4 id="pitch-properties">Pitch properties</h4>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> pc = noteFn((p) =&gt; [ p[<span class="hljs-number">0</span>] ])
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> letter = noteFn((n) =&gt; stepLetter(decode(n).step))
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> accidentals = noteFn((n) =&gt; altAcc(decode(n).alt))
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> octave = pitchFn((p) =&gt; decode(p).oct)
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> simpleNum = ivlFn((i) =&gt; decode(i).step + <span class="hljs-number">1</span>)
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> number = ivlFn((i) =&gt; calcNum(decode(i)))
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> quality = ivlFn((i) =&gt; {
  <span class="hljs-keyword">var</span> p = decode(i)
  <span class="hljs-keyword">return</span> ivl.altToQ(p.step + <span class="hljs-number">1</span>, p.alt)
})
</code></pre>
<h2 id="2-pitch-distances">2. Pitch distances</h2>
<h2 id="3-lists">3. Lists</h2>
<pre><code class="lang-js"><span class="hljs-comment">// items can be separated by spaces, bars and commas</span>
<span class="hljs-keyword">const</span> SEP = <span class="hljs-regexp">/\s*\|\s*|\s*,\s*|\s+/</span>
<span class="hljs-comment">/**
 * Split a string by spaces (or commas or bars). Always returns an array, even if its empty
 * @param {String|Array|Object} source - the thing to get an array from
 * @return {Array} the object as an array
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listArr</span> (<span class="hljs-params">src</span>) </span>{
  <span class="hljs-keyword">return</span> isArr(src) ? src
    : <span class="hljs-keyword">typeof</span> src === <span class="hljs-string">'string'</span> ? src.trim().split(SEP)
    : (src === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> src === <span class="hljs-string">'undefined'</span>) ? []
    : [ src ]
}
</code></pre>
<h4 id="transform-lists">Transform lists</h4>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> listToStr = (v) =&gt; isArr(v) ? v.map(toPitchStr) : toPitchStr(v)
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> listFn = (fn) =&gt; (src) =&gt; {
  <span class="hljs-keyword">var</span> param = listArr(src)
  <span class="hljs-keyword">var</span> result = fn(param)
  <span class="hljs-keyword">return</span> isPitch(param[<span class="hljs-number">0</span>]) ? result : listToStr(result)
}
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">map</span> (<span class="hljs-params">fn, list</span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> map(fn)(list)
  <span class="hljs-keyword">return</span> listFn((arr) =&gt; arr.map(fn))
}
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> filter = (fn, list) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> filter(fn)(list)
  <span class="hljs-keyword">return</span> listFn((arr) =&gt; arr.filter(fn))
}
</code></pre>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> reduce = (fn, o, list) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> (o, list) =&gt; reduce(fn, o)(list)
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> reduce(fn, o)(list)
  <span class="hljs-keyword">return</span> listFn((arr) =&gt; arr.reduce(fn, o))(list)
}
</code></pre>
<h4 id="sort-lists">Sort lists</h4>
<h4 id="transpose-lists">Transpose lists</h4>
<pre><code class="lang-js"><span class="hljs-keyword">var</span> harmonize = (list, pitch) =&gt; {
  <span class="hljs-keyword">return</span> listFn((list) =&gt; list.map(transpose(pitch)))(list)
}
</code></pre>
<p>Fin.</p>

          
        

        
      </div>

      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
